# LeafLog - Employee Shift Management

## Overview
A web-based employee shift management application for scheduling, tracking, and managing employee work shifts. Built with React + Express + PostgreSQL. Features multi-tenant architecture with account isolation, SteepIn kiosk for time tracking, and sage green/warm tan theme.

## Architecture
- **Frontend**: React + TypeScript, Vite, TanStack Query, Wouter routing, Shadcn UI, Tailwind CSS
- **Backend**: Express.js with REST API, express-session for auth
- **Database**: PostgreSQL with Drizzle ORM
- **Auth**: Session-based with bcrypt password hashing, role-based access control
- **Multi-tenancy**: Each account owns its employees/shifts/time entries via `ownerAccountId` on employees table
- **Styling**: Tailwind CSS with sage green (#8B9E8B) primary, warm tan (#E8DCC4) backgrounds

## Project Structure
- `client/src/pages/` - Dashboard, Schedule, Timesheets, Employees, Login, SteepIn, Settings pages
- `client/src/components/` - AppSidebar, ShiftFormDialog, EmployeeFormDialog, EmployeeAvatar, AccessCodeDialog, ThemeProvider/Toggle, TimeInput/TimeRangeInput (custom analog clock picker), DateInput (custom calendar picker)
- `client/src/lib/auth.tsx` - AuthProvider context with login/logout/register hooks
- `client/src/lib/constants.ts` - Colors, departments, roles, utility functions
- `server/auth.ts` - Session setup, auth routes, SteepIn routes, access code generation
- `server/routes.ts` - REST API endpoints with role-based middleware and ownership filtering
- `server/storage.ts` - DatabaseStorage class with Drizzle ORM, multi-tenant queries
- `shared/schema.ts` - Drizzle schemas for employees, shifts, accounts, access_codes, time_entries

## Multi-Tenancy
- **ownerAccountId**: Column on `employees` table linking each employee to the account that created them
- **Data isolation**: All GET endpoints filter by `req.session.userId` (ownerAccountId)
- **Ownership checks**: CRUD operations verify the logged-in user owns the employee/shift before allowing changes
- **Shifts/Time entries**: Filtered indirectly by joining with employees owned by the account
- **Registration**: All new accounts are created as "manager" role with an agencyName

## Authentication System
- **Admin**: Special superuser role â€” `FanEcchyy` account. Sees Feedback Inbox in sidebar.
- **Manager**: Standard manager role. Can send feedback (max 3 per 24h) via sidebar button.
- **Registration**: Any user can create a manager account with username, password, and agency name
- **Employee**: Uses time-limited access codes generated by managers
- **Access codes**: Format `agencyname-employeename-random16hex`, valid 48 hours, new codes expire old ones
- **SteepIn**: Kiosk mode for clock-in/out and break tracking. Requires manager login to activate, then 4-digit employee passcode for actions.

## API Endpoints
### Auth (no auth required)
- `GET /api/auth/me` - Current session info
- `GET /api/auth/setup-required` - Check if any managers exist
- `POST /api/auth/login` - Login with username/password
- `POST /api/auth/register-manager` - Create new manager account (requires agencyName)
- `POST /api/auth/access-code` - Login with access code
- `POST /api/auth/logout` - Logout

### Protected (requires auth, filtered by ownerAccountId)
- `GET/POST /api/employees` - List/create employees (filtered by owner)
- `GET/PATCH/DELETE /api/employees/:id` - Get/update/delete employee (ownership verified)
- `GET/POST /api/shifts` - List/create shifts (filtered by owner's employees)
- `GET/PATCH/DELETE /api/shifts/:id` - Get/update/delete shift

### Access Codes (admin/manager only)
- `POST /api/access-codes/generate` - Generate new access code for employee
- `GET /api/access-codes/:employeeId` - Get code history for employee

### Break Policy (admin/manager only)
- `GET /api/settings/break-policy` - Get paid break minutes and max break minutes
- `PATCH /api/settings/break-policy` - Update break policy settings

### SteepIn/Kiosk
- `GET /api/kiosk/employees` - List active employees (filtered by session owner if logged in)
- `POST /api/kiosk/action` - Record clock-in/out/break-start/break-end (requires passcode)
- `GET /api/kiosk/entries/:employeeId` - Get today's time entries
- `GET /api/kiosk/entries` - Get time entries (filtered by owner)

## Key Features
- Dashboard with stats, today's/tomorrow's schedule, unscheduled employees
- Weekly and monthly calendar views with color-coded shifts
- Employee management with search, CRUD, role filters
- Shift assignment with employee selection, time/date, color coding
- Multi-tenant data isolation (each account sees only their own data)
- Timesheets with actual worked hours from kiosk clock-in/out entries
- Access code generation for employee onboarding
- SteepIn kiosk for clock-in/out and break tracking
- Settings page with custom role management (up to 6 roles per account)
- Dark/light theme toggle
- Responsive sidebar navigation
- TimeInput/TimeRangeInput components for compact time entry

## Storage Layer Notes
- Time entry queries use raw SQL with `pool.query()` and `entry_date::text` cast (Drizzle had issues with date column)
- `pool` is exported from `storage.ts` for direct SQL access
- Multi-tenant filtering uses `getEmployeeIdsByOwner()` helper to get employee IDs, then filters with `IN` clause
